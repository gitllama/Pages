<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ReactReduxRedmine</title>
  <script type="text/javascript">
  /*dummy*/
  /*ここから*/
  </script>

  <script src="https://unpkg.com/react@15.6.1/dist/react.min.js"></script>
  <script src="https://unpkg.com/react-dom@15.6.1/dist/react-dom.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/5.0.6/react-redux.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.38/browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.4.2/js-yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.31.2/react-bootstrap.min.js"></script>

  <script type="text/babel">
  //RedminにView customizes puluginでReactを埋め込む場合
  // ここから～ここまで を記述すると
  //dummyのscriptタグを含んだこのようなhead構成になる

let {
      Button,FormGroup,FormControl,
      PageHeader, FieldGroup,
      Grid, Row, Col, Jumbotron, Table,
      Panel, Label, Alert
    } = window.ReactBootstrap;


  let header = (()=>{/*
    <head>
      <meta charset="UTF-8">
      <title>iframe</title>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/latest/css/bootstrap.min.css">
    </head>
  */}).toString().match(/\/\*([^]*)\*\//)[1];

  const addrdefault = "192.168.1.33"


  /******** Action, Action Creators ********/

  const submit =(i)=>({ type: 'SUBMIT', value: i });
  const onload =()=>({ type: 'ONLOAD'});

  /******** Reducers, store ********/

  const initialState = {
    onload : false,
    conditions : "",
    result : ""
  };

  function Reducers(state = initialState, action) {
    console.log(action.type);
    switch (action.type) {
      case 'ONLOAD':
        return {
          ...state,
          onload: true
        }
      case 'SUBMIT':
        return {
          ...state,
          onload: false,
          conditions: action.value.conditions,
          result: action.value.result
        }
      default:
        //init時にaction.type = @@redux/INIT呼ばれる
        return state;
    }
  }

  var store = Redux.createStore(Reducers);


  /******** React Components ********/

  const mapStateToProps =(state)=>({ state: state });


  //input

  class uInputComponent extends React.Component {
    onSubmit(){
      //非同期処理のためComponentで処理してから結果のみdispatchに投げる

      let _addr = ReactDOM.findDOMNode(this.refs.addr).value;
      let _id = ReactDOM.findDOMNode(this.refs.ticket).value;
      let conditions = "";
      let result = "";

      let _url = `http://${_addr}/redmine/issues/${_id}.json?format=json&include=relations,attachments`;

      this.props.dispatch(onload());
      //再描画がかかってないね

      fetch(_url).then(response => response.json())
      .then(json => {
        for(let i of json.issue.custom_fields){
          switch(i.name){
            case 'Conditions':
              conditions = i.value;
              break;
            case 'Result':
              result = i.value;
              break;
            default:
              break;
          }
        }
        this.props.dispatch(submit({
          conditions : conditions,
          result : result
        }));
      });
    }
    render() {
      return (
        <div>
          <table border="0">
            <tr>
              <td> <label>addr :</label> </td>
              <td> <input type="text" ref="addr" defaultValue={addrdefault} /> </td>
            </tr>
            <tr>
              <td> <label>ticket No</label> </td>
              <td> <input type="text" ref="ticket" defaultValue={"444"} /> </td>
            </tr>
          </table>
          <button onClick={this.onSubmit.bind(this)}>submit</button>
        </div>
      );
    }
  }
  var InputComponent = ReactRedux.connect(mapStateToProps)(uInputComponent);

  //app


  class uApp extends React.Component {
    componentDidMount(){
    }
    componentDidUpdate(prevProps, prevState){
      //インラインにsrcdoc={}書いてもReactでは反応しないので
      ReactDOM.findDOMNode(this.refs.uframe).srcdoc
       = header
       + ReactDOM.findDOMNode(this.refs.main).innerHTML;
       //<div dangerouslySetInnerHTML={{__html: this.props.state.html}}/>
    }
    render() {
      const hoge =(flag)=>{
        if(flag){
          return(
            <div>Now Loading...</div>
          );
        }else{
          return(
            <div>
              <div>{this.props.state.conditions}</div>
              <div>{this.props.state.result}</div>
            </div>
          );
        }
      }
      return (
        <div>
          <div>
            <InputComponent />
          </div>
          <div ref="main" style={{display:"none"}}>
            {hoge(this.props.state.onload)}
          </div>
          <hr/>
          <h3>output</h3>
          <div>
            <iframe ref="uframe" width="100%" height="500" style={{border:"none"}}></iframe>
          </div>
          <hr/>
        </div>
      );
    }
  }
  var App = ReactRedux.connect(mapStateToProps)(uApp);


  /******** Provider, Render ********/

  var Provider = ReactRedux.Provider;
  ReactDOM.render(
    <Provider store={store}>
      <App />
    </Provider>,
    document.querySelector('#app')
  );

  /*ここまで*/

  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
